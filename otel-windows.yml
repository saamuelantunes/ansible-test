---
- name: Deploy OpenTelemetry Collector on Windows
  hosts: all
  gather_facts: no

  tasks:
    - name: Create folder for Otel Collector
      win_file:
        path: C:\otel
        state: directory

    - name: Download Otel Collector tar.gz
      win_get_url:
        url: https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.123.1/otelcol-contrib_0.123.1_windows_amd64.tar.gz
        dest: C:\otel\otelcol-contrib.tar.gz

    - name: Extract Otel Collector with tar
      win_command: powershell.exe -Command "tar -xf 'C:\\otel\\otelcol-contrib.tar.gz' -C 'C:\\otel'"
      args:
        creates: C:\otel\otelcol-contrib.exe
    
    - name: Upload config.yaml
      win_copy:
        dest: C:\otel\config.yaml
        content: |
          receivers:
            hostmetrics:
              collection_interval: 10s
              scrapers:
                cpu:
                memory:

          exporters:
            logging:
              loglevel: debug

          service:
            pipelines:
              metrics:
                receivers: [hostmetrics]
                exporters: [logging]

    - name: Install OpenTelemetry as a service
      win_command: C:\otel\otelcol.exe --config C:\otel\config.yaml --service install

    - name: Start the service
      win_service:
        name: otelcol
        start_mode: auto
        state: started
